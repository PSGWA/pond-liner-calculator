<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>คำนวณค่า ผ้าปูบ่อ • คลองไส้ไก่ • บ่อกลม • เหล็กแบน • สรุปออเดอร์</title>
  <style>
    /* ========= THEME: Blue & White (Rectangular Tabs) ========= */
    :root{
      --clr-primary:#2563eb;        /* main blue */
      --clr-primary-dark:#1d4ed8;   /* hover blue */
      --clr-secondary:#60a5fa;      /* light blue */
      --clr-danger:#dc2626;         /* red */
      --clr-warning:#facc15;        /* amber */
      --clr-bg:#ffffff;             /* page bg */
      --clr-card:#ffffff;           /* card bg */
      --clr-muted:#6b7280;          /* gray text */
      --shadow:0 8px 20px rgba(0,0,0,.06);
      --radius:12px;                /* keep layout the same */
    }
    *{box-sizing:border-box;font-family:'Segoe UI', Tahoma, Arial, sans-serif}
    body{margin:0;background:var(--clr-bg);color:#111827}

    h1{ text-align:center; margin:26px 0 18px; font-size:26px; }

    /* Tabs — rectangular */
    .tabs{ display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:0 0 18px; }
    .tab{ padding:10px 18px; cursor:pointer; background:#fff; border-radius:0; border:1px solid #e5e7eb; transition:.25s; font-weight:600; color:#111827 }
    .tab:hover{ background:#f3f4f6; }
    .tab.active{ background:var(--clr-primary); color:#fff; border-color:var(--clr-primary); }

    .container{ max-width:980px; margin:0 auto 40px; padding:24px; background:var(--clr-card); border-radius:var(--radius); box-shadow:var(--shadow); }
    label{ display:block; margin-bottom:8px; font-weight:600; }
    .radio-group{ display:flex; flex-wrap:wrap; gap:10px; margin-bottom:14px; }

    input[type="number"], input[type="text"], select, textarea{ width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:16px; font-size:15px; background:#fff; transition:border-color .2s ease, box-shadow .2s ease; }
    input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus{ outline:none; border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35); }

    textarea{ resize:none; background:#f9fafb; min-height:140px; }

    button{ border:none; border-radius:10px; padding:12px 18px; font-size:15px; font-weight:600; cursor:pointer; transition:.25s; }
    .btn-primary{ background:var(--clr-primary); color:#fff; }
    .btn-primary:hover{ background:var(--clr-primary-dark); }
    .btn-secondary{ background:var(--clr-secondary); color:#fff; }
    .btn-warning{ background:var(--clr-warning); color:#111; }
    .btn-danger{ background:var(--clr-danger); color:#fff; }
    .copy-btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 16px; border-radius:10px; background:var(--clr-secondary); color:#fff; font-weight:700; }
    .copy-btn:hover{ filter:brightness(.96); }

    .hidden{ display:none; }

    /* Summary/Items tables */
    .items-table{ width:100%; border-collapse:collapse; margin-bottom:14px; border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; }
    .items-table thead{ background:var(--clr-primary); color:#fff; }
    .items-table th, .items-table td{ padding:10px; text-align:center; }
    .items-table tbody tr:nth-child(odd){ background:#f8fafc; }

    @media (max-width:600px){
      .container{ padding:14px; }
      .tab{ padding:8px 14px; font-size:14px; }
      button{ font-size:14px; }
      .items-table{ display:block; overflow-x:auto; }
      .row{ grid-template-columns:1fr; }
    }

    .hint{color:#6b7280; font-size:13px; margin:8px 0 10px; line-height:1.55; word-break:break-word; }
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .items-table input[type="number"], .items-table select{ color:#111827 !important; -webkit-text-fill-color:#111827; background:#fff; width:100%; height:38px; text-align:center; }
    .items-table input::placeholder{ color:#9ca3af; }
    .items-table td:nth-child(2), .items-table td:nth-child(3), .items-table td:nth-child(4), .items-table td:nth-child(6){ min-width:90px; }
    /* ensure first column (select) wide enough so text won't clip */
    .items-table th:first-child, .items-table td:first-child{ min-width: 180px; }
  </style>
</head>
<body>
  <h1>คำนวณค่า ผ้าปูบ่อ / คลองไส้ไก่ / บ่อกลม / เหล็กแบน / สรุปออเดอร์</h1>
  <div class="tabs">
    <div class="tab active" data-tab="pond">บ่อขุด</div>
    <div class="tab" data-tab="canal">คลองไส้ไก่</div>
    <div class="tab" data-tab="circular">บ่อกลม</div>
    <div class="tab" data-tab="flatbar">เหล็กแบน</div>
    <div class="tab" data-tab="summary">สรุปออเดอร์</div>
  </div>

  <!-- POND -->
  <div class="container" id="pondContainer">
    <form id="pondForm">
      <label>เลือกความหนา (มม.):</label>
      <div class="radio-group">
        <label><input type="radio" name="size" value="0.3" required> 0.3 มม.</label>
        <label><input type="radio" name="size" value="0.5" required> 0.5 มม.</label>
        <label><input type="radio" name="size" value="0.75" required> 0.75 มม.</label>
        <label><input type="radio" name="size" value="all" required> ไม่ระบุความหนา</label>
      </div>

      <label>ความกว้าง (เมตร):</label>
      <input type="number" id="pondWidth" step="0.01" placeholder="กรอกความกว้าง" required>

      <label>ความยาว (เมตร):</label>
      <input type="number" id="pondLength" step="0.01" placeholder="กรอกความยาว" required>

      <label>ความลึก (เมตร, ไม่บังคับ):</label>
      <input type="number" id="pondDepth" step="0.01" placeholder="กรอกความลึก (ถ้ามี)">

      <label><input type="checkbox" id="pondSpecialProvince" value="yes"> ส่งจังหวัดพัทลุง สตูล ปัตตานี ยะลา นราธิวาส (เพิ่ม 5 บาท/ตร.ม. สูงสุด 2,000)</label>
      <label><input type="checkbox" id="pondDiscount5" value="yes"> ใช้ส่วนลดพิเศษ 5%</label>
      <label><input type="checkbox" id="pondFactoryBlue" value="yes"> เพจ "น้ำเงิน ราคาโรงงาน" (ใช้ราคา 40/60/80 บาท/ตร.ม.)</label>
      <div class="hint">เมื่อเลือกราคาโรงงาน: 0.3 = 40, 0.5 = 60, 0.75 = 80 บาท/ตร.ม.</div>

      <button type="submit" class="btn-primary">คำนวณ</button>
      <button type="button" id="pondReset" class="btn-warning hidden">คำนวณใหม่</button>
    </form>

    <textarea id="pondResult" readonly placeholder="ผลลัพธ์จะแสดงที่นี่"></textarea>
    <button id="pondCopy" class="copy-btn hidden">คัดลอกข้อความ</button>
  </div>

  <!-- CANAL -->
  <div class="container hidden" id="canalContainer">
    <form id="canalForm">
      <label>เลือกความหนา (มม.):</label>
      <div class="radio-group">
        <label><input type="radio" name="canalSize" value="0.5" required> 0.5 มม. (LDPE)</label>
      </div>
      <label>ความกว้าง (เมตร):</label>
      <input type="number" id="canalWidth" step="0.01" placeholder="กรอกความกว้าง" required>
      <label>ความยาว (เมตร):</label>
      <input type="number" id="canalLength" step="0.01" placeholder="กรอกความยาว" required>
      <label>ความลึก (เมตร, ไม่บังคับ):</label>
      <input type="number" id="canalDepth" step="0.01" placeholder="กรอกความลึก (ถ้ามี)">
      <label><input type="checkbox" id="canalSpecialProvince" value="yes"> ส่งจังหวัดพัทลุง สตูล ปัตตานี ยะลา นราธิวาส (เพิ่ม 5 บาท/ตร.ม.)</label>
      <label><input type="checkbox" id="canalDiscount5" value="yes"> ใช้ส่วนลดพิเศษ 5%</label>
      <label><input type="checkbox" id="canalFactoryBlue" value="yes"> เพจ "น้ำเงิน ราคาโรงงาน" (LDPE 0.5 = 50 บาท/ตร.ม.)</label>

      <button type="submit" class="btn-primary">คำนวณ</button>
      <button type="button" id="canalReset" class="btn-warning hidden">คำนวณใหม่</button>
    </form>

    <textarea id="canalResult" readonly placeholder="ผลลัพธ์จะแสดงที่นี่"></textarea>
    <button id="canalCopy" class="copy-btn hidden">คัดลอกข้อความ</button>
  </div>

  <!-- CIRCULAR -->
  <div class="container hidden" id="circularContainer">
    <form id="circularForm">
      <label>เลือกเส้นผ่านศูนย์กลาง (เมตร):</label>
      <div class="radio-group">
        <label><input type="radio" name="circleDiameter" value="6" required> 6 เมตร</label>
        <label><input type="radio" name="circleDiameter" value="8" required> 8 เมตร</label>
        <label><input type="radio" name="circleDiameter" value="10" required> 10 เมตร</label>
        <label><input type="radio" name="circleDiameter" value="12" required> 12 เมตร</label>
      </div>
      <button type="submit" class="btn-primary">แสดงข้อมูล</button>
      <button type="button" id="circularReset" class="btn-warning hidden">เริ่มใหม่</button>
    </form>
    <textarea id="circularResult" readonly placeholder="ผลลัพธ์จะแสดงที่นี่"></textarea>
    <button id="circularCopy" class="copy-btn hidden">คัดลอกข้อความ</button>
  </div>

  <!-- FLATBAR -->
  <div class="container hidden" id="flatbarContainer">
    <form id="flatbarForm">
      <label>ข้อมูลผู้รับ (ชื่อ-ที่อยู่-เบอร์โทร)</label>
      <textarea id="flatbarCustInfo" placeholder="คัดลอกข้อมูลลูกค้ามาวางที่นี่"></textarea>

      <!-- ผ้า: ย้ายขึ้นด้านบน + บังคับต้องมีอย่างน้อย 1 รายการ -->
      <h3 style="margin-top:0">รายการผ้า (จำเป็นต้องเลือกอย่างน้อย 1)</h3>
      <table class="items-table" id="clothTableFlatbar">
        <thead>
          <tr>
            <th>แบบ</th>
            <th>กว้าง (ม.)</th>
            <th>ยาว (ม.)</th>
            <th>จำนวน</th>
            <th>ลบ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" id="flatbarAddCloth" class="btn-secondary" style="margin-bottom:8px">+ เพิ่มรายการผ้า</button>
      <div class="hint">ค่าเริ่มต้นเป็น "ระบุเอง" (คิด 250 บาท/ตร.ม.) • ถ้าเลือกแบบสำเร็จ ระบบใส่กว้าง×ยาวให้อัตโนมัติและคิดราคาตามชุดสำเร็จ</div>      <div class="row">
        <div>
          <label>Facebook (ชื่อโปรไฟล์ลูกค้า)</label>
          <input type="text" id="flatbarFacebook" placeholder="เช่น ยอดชาย เฝดสูงเนิน">
        </div>
        <div>
          <label>วันที่ (ระบุเอง)</label>
          <input type="text" id="flatbarDate" placeholder="เช่น 20/8/68">
        </div>
      </div>

      <label>เลือกเพจ</label>
      <select id="flatbarPageSelect">
        <option value="">เลือกเพจ...</option>
        <option value="ส้ม">ส้ม</option>
        <option value="ม่วง">ม่วง</option>
        <option value="น้ำเงิน">น้ำเงิน</option>
        <option value="บ่อใหญ่">บ่อใหญ่</option>
        <option value="รถบรรทุก">รถบรรทุก</option>
        <option value="MP">MP</option>
        <option value="โทร">โทร</option>
        <option value="กลุ่มเฟส (เตย)">กลุ่มเฟส (เตย)</option>
        <option value="PP Dump">PP Dump</option>
        <option value="เซฟทรัก">เซฟทรัก</option>
        <option value="Line">Line</option>
      </select>

      <label>ชื่อแอดมิน</label>
      <select id="flatbarAdminSelect">
        <option value="">เลือกชื่อแอดมิน...</option>
        <option value="หมิว">หมิว</option>
        <option value="เตย">เตย</option>
        <option value="จ๋า">จ๋า</option>
        <option value="เบล">เบล</option>
        <option value="หงส์">หงส์</option>
        <option value="ภีร์">ภีร์</option>
        <option value="กมล">กมล</option>
        <option value="pekky">pekky</option>
        <option value="พลอย">พลอย</option>
        <option value="แจม">แจม</option>
        <option value="ใยฝ้าย">ใยฝ้าย</option>
      </select>

      <hr style="opacity:.25; margin:16px 0">

      <label>คำนวณเหล็กแบน (ไม่บังคับ)</label>
      <div class="hint">สูตรราคาเหล็กแบน: 300 + (ความยาวรถ × 50 × 4) บาท  และ +150 บาท ถ้า "มีผ้าขึ้นด้านหน้า" • จำนวนคูณ 4 จุด • เหล็กยาว 2 ม./3 ม. จะถูกเลือกอัตโนมัติ</div>
      <div class="row">
        <div>
          <label>ความยาวรถ (เมตร) — จำนวนเต็ม เช่น 4, 5, 6, 7</label>
          <input type="number" id="carLength" step="1" min="2" placeholder="กรอกความยาวรถ (เมตร)">
        </div>
        <div>
          <label>&nbsp;</label>
          <label><input type="checkbox" id="hasFrontCloth"> มีผ้าขึ้นด้านหน้า (+150 บาท)</label>
        </div>
      </div>

      <button type="submit" class="btn-primary">คำนวณและสร้างสรุป</button>
      <button type="button" id="flatbarReset" class="btn-warning hidden">คำนวณใหม่</button>
    </form>
    <textarea id="flatbarResult" readonly placeholder="ผลลัพธ์จะแสดงที่นี่"></textarea>
    <button id="flatbarCopy" class="copy-btn hidden">คัดลอกข้อความ</button>
  </div>

  <!-- SUMMARY (ไม่รวมเหล็กแบนแล้ว) -->
  <div class="container hidden" id="summaryContainer">
    <form id="summaryForm">
      <label>ข้อมูลผู้รับ (ชื่อ-ที่อยู่-เบอร์โทร)</label>
      <textarea id="custInfo" placeholder="คัดลอกข้อมูลลูกค้ามาวางที่นี่"></textarea>

      <h3 style="margin-top:0">รายการผ้า</h3>
      <table class="items-table" id="itemsTable">
        <thead>
          <tr>
            <th>ความหนา</th>
            <th>กว้าง (ม.)</th>
            <th>ยาว (ม.)</th>
            <th>ลึก (ม.)</th>
            <th>คลองไส้ไก่?</th>
            <th>จำนวน</th>
            <th>ลบ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" id="addItem" class="btn-secondary">+ เพิ่มรายการ</button>

      <label style="margin-top:14px"><input type="checkbox" id="summarySpecial"> จังหวัดพิเศษ (+5 บาท/ตร.ม. สูงสุด 1,500 บาท)</label>
      <label><input type="checkbox" id="summaryDiscount5"> ใช้ส่วนลดพิเศษ 5%</label>
      <label><input type="checkbox" id="summaryFactoryBlue"> เพจ "น้ำเงิน ราคาโรงงาน" (0.3L=40, 0.5L=50, 0.5H=60, 0.75H=80 บาท/ตร.ม.)</label>

      <label>เลือกเพจ</label>
      <select id="pageSelect">
        <option value="">เลือกเพจ...</option>
        <option value="ส้ม">ส้ม</option>
        <option value="ม่วง">ม่วง</option>
        <option value="น้ำเงิน">น้ำเงิน</option>
        <option value="บ่อใหญ่">บ่อใหญ่</option>
        <option value="รถบรรทุก">รถบรรทุก</option>
        <option value="MP">MP</option>
        <option value="โทร">โทร</option>
        <option value="กลุ่มเฟส (เตย)">กลุ่มเฟส (เตย)</option>
        <option value="PP Dump">PP Dump</option>
        <option value="เซฟทรัก">เซฟทรัก</option>
        <option value="Line">Line</option>
      </select>

      <label>ชื่อแอดมิน</label>
      <select id="adminSelect">
        <option value="">เลือกชื่อแอดมิน...</option>
        <option value="หมิว">หมิว</option>
        <option value="เตย">เตย</option>
        <option value="จ๋า">จ๋า</option>
        <option value="เบล">เบล</option>
        <option value="หงส์">หงส์</option>
        <option value="ภีร์">ภีร์</option>
        <option value="กมล">กมล</option>
        <option value="pekky">pekky</option>
        <option value="พลอย">พลอย</option>
        <option value="แจม">แจม</option>
        <option value="ใยฝ้าย">ใยฝ้าย</option>
      </select>

      <button type="submit" class="btn-primary" style="margin-top:20px">ยืนยันสรุปออเดอร์</button>
    </form>
    <textarea id="summaryResult" readonly style="margin-top:16px"></textarea>
    <button id="summaryCopy" class="copy-btn hidden" style="margin-top:12px">คัดลอกข้อความ</button>
  </div>

  <script>
    // --- Tab control ---
    const tabs = document.querySelectorAll('.tab');
    const sections = { pond: 'pondContainer', canal: 'canalContainer', circular: 'circularContainer', flatbar: 'flatbarContainer', summary: 'summaryContainer' };
    tabs.forEach(tab => tab.addEventListener('click', () => {
      tabs.forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      Object.values(sections).forEach(id=>document.getElementById(id).classList.add('hidden'));
      const target = tab.getAttribute('data-tab');
      document.getElementById(sections[target]).classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    }));

    // --- Pricing helpers ---
    function getPondPriceList(isFactory){
      if(isFactory){
        return { '0.3':{price:40, material:'LDPE'}, '0.5':{price:60, material:'HDPE'}, '0.75':{price:80, material:'HDPE'} };
      }
      return { '0.3':{price:40, material:'LDPE'}, '0.5':{price:65, material:'HDPE'}, '0.75':{price:85, material:'HDPE'} };
    }

    // ---------- POND LOGIC ----------
    const pondForm = document.getElementById('pondForm');
    const pondWidth = document.getElementById('pondWidth');
    const pondLength = document.getElementById('pondLength');
    const pondDepth = document.getElementById('pondDepth');
    const pondResult = document.getElementById('pondResult');
    const pondCopy = document.getElementById('pondCopy');
    const pondReset = document.getElementById('pondReset');
    const pondSpecialProvince = document.getElementById('pondSpecialProvince');
    const pondDiscount5 = document.getElementById('pondDiscount5');
    const pondFactoryBlue = document.getElementById('pondFactoryBlue');

    pondForm.onsubmit = function(e){
      e.preventDefault();
      const size = document.querySelector('input[name="size"]:checked');
      let w = parseFloat(pondWidth.value), l = parseFloat(pondLength.value), d = parseFloat(pondDepth.value || 0);
      if(!size || w<=0 || l<=0){ alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง'); return; }
      const ow=w, ol=l;
      if(d>0){ w = w + d*2 + 2; l = l + d*2 + 2; }
      const priceList = getPondPriceList(pondFactoryBlue.checked);
      const area = w*l; let text='';
      if(size.value==='all'){
        const p03=Math.floor(area*priceList['0.3'].price), p05=Math.floor(area*priceList['0.5'].price), p075=Math.floor(area*priceList['0.75'].price);
        text += `จากขนาดที่ลูกค้าแจ้งมา ราคาดังนี้ค่ะ\n`;
        text += `✅ LDPE หนา 0.3 มม. – ${p03.toLocaleString()} บาท (${priceList['0.3'].price} บาท/ตร.ม.)\n`;
        text += `✅ HDPE หนา 0.5 มม. – ${p05.toLocaleString()} บาท (${priceList['0.5'].price} บาท/ตร.ม.)\n`;
        text += `✅ HDPE หนา 0.75 มม. – ${p075.toLocaleString()} บาท (${priceList['0.75'].price} บาท/ตร.ม.)\n\n`;
        text += `ยิ่งหนา ยิ่งทนทาน ต่อสภาพแวดล้อมรุนแรงและพื้นผิวขรุขระ`;
        if(pondFactoryBlue.checked){ text += `\n(ราคานี้เป็นราคาโรงงาน เพจน้ำเงิน)`; }
        text += `\n\nสนใจความหนาไหนแจ้งได้เลยค่ะ 😊`;
      }else{
        const sel = priceList[size.value];
        let total = Math.floor(area * sel.price);
        if(pondDiscount5.checked){ total = Math.floor(total * 0.95); }
        let shipping = 0; if(total < 5000) shipping += 300; if(pondSpecialProvince.checked){ shipping += Math.min(Math.floor(5*area), 2000); }
        const sum = Math.floor(total + shipping);
        text += `📍 รายการ:\n`;
        text += `ผ้าพลาสติก ${sel.material} หนา ${size.value} มม. (${sel.price} บาท/ตร.ม.)\n`;
        text += `ขนาด ${ow} ม. × ${ol} ม.${d>0?` ลึก ${d} ม.`:''}\n`;
        text += `ผ้าขนาด ${w} ม. × ${l} ม. = ${area.toLocaleString()} ตร.ม.\n(ขนาดผ้านี้ต้องวัดแนบพื้น และเผื่อขอบข้างละ 1 เมตรแล้ว)\n\n`;
        if(shipping>0){ text += `ราคาผ้า ${total.toLocaleString()} บาท\nค่าจัดส่ง ${shipping.toLocaleString()} บาท\n`; }
        text += `📌 สรุปยอดสั่งซื้อทั้งหมด: ${sum.toLocaleString()} บาท\n`;
        if(pondFactoryBlue.checked) text += `(ราคาโรงงาน เพจน้ำเงิน)\n`;
        if(pondDiscount5.checked) text += `(ส่วนลดพิเศษ 5%)\n`;
        text += `รบกวนลูกค้าตรวจสอบรายการให้ครบก่อนยืนยันนะคะ ✨\nหากเริ่มผลิตแล้ว จะไม่สามารถแก้ไขหรือยกเลิกได้ค่ะ\n\n`;
        if(shipping<=0) text += `(ส่งฟรี ชำระเงินเมื่อได้รับของค่ะ)`;
        if(sum>=5000){ const dep=Math.floor(sum*0.1), bal=Math.floor(sum-dep); text += `\n✅ ชำระมัดจำ 10% (${dep.toLocaleString()} บาท) เพื่อยืนยันคำสั่งซื้อ\n\n📦 แจ้งชื่อ-ที่อยู่ & เบอร์โทรศัพท์\n🚚 สินค้าจะจัดส่งถึงลูกค้าภายใน 4-6 วัน\nCOD ${bal.toLocaleString()} บาท โอนเมื่อได้รับของค่ะ 😉\n`; }
        else{ text += `ยืนยันการสั่งซื้อแล้วแจ้งชื่อ-ที่อยู่ & เบอร์โทรศัพท์ค่ะ\n🚚 สินค้าจะจัดส่งถึงลูกค้าภายใน 4-6 วัน\nCOD ${sum.toLocaleString()} บาท โอนเมื่อได้รับของค่ะ 😉\n`; }
      }
      pondResult.value = text.trim(); pondCopy.classList.remove('hidden'); pondReset.classList.remove('hidden');
    };
    pondCopy.onclick = ()=>{ pondResult.select(); document.execCommand('copy'); alert('คัดลอกข้อความแล้ว'); };
    pondReset.onclick = ()=>{ pondForm.reset(); pondResult.value=''; pondCopy.classList.add('hidden'); pondReset.classList.add('hidden'); };

    // ---------- CANAL LOGIC ----------
    const canalForm = document.getElementById('canalForm');
    const canalWidth = document.getElementById('canalWidth');
    const canalLength = document.getElementById('canalLength');
    const canalDepth = document.getElementById('canalDepth');
    const canalResult = document.getElementById('canalResult');
    const canalCopy = document.getElementById('canalCopy');
    const canalReset = document.getElementById('canalReset');
    const canalSizeRadios = document.querySelectorAll('input[name="canalSize"]');
    const canalSpecialProvince = document.getElementById('canalSpecialProvince');
    const canalDiscount5 = document.getElementById('canalDiscount5');
    const canalFactoryBlue = document.getElementById('canalFactoryBlue');

    canalSizeRadios.forEach(r=>r.addEventListener('change',()=>{ if(r.value==='0.5'){ canalWidth.value=4; canalWidth.disabled=true; } else { canalWidth.disabled=false; } }));

    canalForm.onsubmit = function(e){
      e.preventDefault();
      const size = document.querySelector('input[name="canalSize"]:checked');
      let w = parseFloat(canalWidth.value), l = parseFloat(canalLength.value), d = parseFloat(canalDepth.value || 0);
      if(!size || w<=0 || l<=0){ alert('กรุณากรอกข้อมูลให้ครบถ้วนและถูกต้อง'); return; }
      const ow=w, ol=l; if(d>0){ w=w + d*2 + 1; l=l + d*2 + 1; }
      const basePrice = 60; // LDPE 0.5 ปกติ
      const pricePerSqm = (canalFactoryBlue && canalFactoryBlue.checked) ? 50 : basePrice; // เพจน้ำเงิน = 50
      const mat = 'LDPE';

      const area = w*l; let total = Math.floor(area * pricePerSqm);
      let discountAmount=0; if(canalDiscount5.checked){ discountAmount = Math.floor(total*0.05); total -= discountAmount; }
      let shipping = total<5000 ? 300 : 0; if(canalSpecialProvince.checked){ shipping += Math.floor(5*area); }
      const sum = Math.floor(total + shipping);

      let text = `📍 รายการ:\n`;
      text += `ผ้าพลาสติก ${mat} หนา 0.5 มม. (${pricePerSqm} บาท/ตร.ม.)\n`;
      text += `ขนาด ${ow} ม. × ${ol} ม.${d>0?` ลึก ${d} ม.`:''} = ${area.toLocaleString()} ตร.ม.\n(ขนาดผ้านี้ต้องวัดแนบพื้น และเผื่อขอบข้างละ 0.5 เมตรแล้ว)\n\n`;
      text += `📌 สรุปยอดสั่งซื้อทั้งหมด: ${sum.toLocaleString()} บาท\n`;
      if(canalFactoryBlue && canalFactoryBlue.checked){ text += `(ราคาโรงงาน เพจน้ำเงิน)\n`; }
      if(canalDiscount5.checked){ text += `(ส่วนลดพิเศษ 5% = ${discountAmount.toLocaleString()} บาท)\n`; }
      text += `รบกวนลูกค้าตรวจสอบรายการให้ครบก่อนยืนยันนะคะ ✨\nหากเริ่มผลิตแล้ว จะไม่สามารถแก้ไขหรือยกเลิกได้ค่ะ\n\n`;
      if(shipping>0){ text += `ราคาผ้า ${total.toLocaleString()} บาท\nค่าจัดส่งรวม ${shipping.toLocaleString()} บาท\n`; } else { text += `(ส่งฟรี ชำระเงินเมื่อได้รับของค่ะ)\n`; }
      text += `ยอดรวม ${sum.toLocaleString()} บาท\n\n`;
      if(sum>=5000){ const dep=Math.floor(sum*0.1), bal=Math.floor(sum-dep); text += `✅ ชำระมัดจำ 10% (${dep.toLocaleString()} บาท) เพื่อยืนยันคำสั่งซื้อ\n\n📦 แจ้งชื่อ-ที่อยู่ & เบอร์โทรศัพท์\n🚚 สินค้าจะจัดส่งถึงลูกค้าภายใน 4-6 วัน\nCOD ${bal.toLocaleString()} บาท โอนเมื่อได้รับของค่ะ 😉\n`; }
      else { text += `ยืนยันการสั่งซื้อแล้วแจ้งชื่อ-ที่อยู่ & เบอร์โทรศัพท์ค่ะ\n🚚 สินค้าจะจัดส่งถึงลูกค้าภายใน 4-6 วัน\nCOD ${sum.toLocaleString()} บาท โอนเมื่อได้รับของค่ะ 😉\n`; }

      canalResult.value = text.trim(); canalCopy.classList.remove('hidden'); canalReset.classList.remove('hidden');
    };
    canalCopy.onclick = ()=>{ canalResult.select(); document.execCommand('copy'); alert('คัดลอกข้อความแล้ว'); };
    canalReset.onclick = ()=>{ canalForm.reset(); canalWidth.disabled=false; canalResult.value=''; canalCopy.classList.add('hidden'); canalReset.classList.add('hidden'); };

    // ---------- CIRCULAR LOGIC ----------
    const circularForm = document.getElementById('circularForm');
    const circularResult = document.getElementById('circularResult');
    const circularCopy = document.getElementById('circularCopy');
    const circularReset = document.getElementById('circularReset');
    window.circularInfo = { '6':{volume:34000, price:35000}, '8':{volume:60000, price:50000}, '10':{volume:95000, price:63000}, '12':{volume:135000, price:72000} };

    circularForm.onsubmit = function(e){
      e.preventDefault();
      const dia = document.querySelector('input[name="circleDiameter"]:checked');
      if(!dia){ alert('กรุณาเลือกขนาดบ่อกลม'); return; }
      const data = window.circularInfo[dia.value];
      let text = `📌 สรุปยอดสั่งซื้อทั้งหมด (บ่อกลม)\n`;
      text += `บ่อกลม เมทัลชีทบลูสโคป สูง 1.2 ม. เส้นผ่านศูนย์กลาง ${dia.value} เมตร\n`;
      text += `ความจุประมาณ ${data.volume.toLocaleString()} ลิตร\nราคา ${data.price.toLocaleString()} บาท\n`;
      text += data.price>=80000?`\nสั่งเกิน 80,000 ส่งพร้อมติดตั้งฟรี!`:`\n(ค่าจัดส่งหรือติดตั้ง คิดเพิ่มตามระยะทาง)`;
      text += `\n\nกรุณาตรวจสอบรายละเอียดสินค้าให้ครบถ้วนก่อนยืนยันการสั่งซื้อ`;
      circularResult.value = text.trim(); circularCopy.classList.remove('hidden'); circularReset.classList.remove('hidden');
    };
    circularCopy.onclick = ()=>{ circularResult.select(); document.execCommand('copy'); alert('คัดลอกข้อความแล้ว'); };
    circularReset.onclick = ()=>{ circularForm.reset(); circularResult.value=''; circularCopy.classList.add('hidden'); circularReset.classList.add('hidden'); };

    // ---------- FLATBAR LOGIC (ผ้าอยู่ด้านบน + บังคับ) ----------
    const flatbarForm = document.getElementById('flatbarForm');
    const flatbarResult = document.getElementById('flatbarResult');
    const flatbarCopy = document.getElementById('flatbarCopy');
    const flatbarReset = document.getElementById('flatbarReset');
    const carLengthInput = document.getElementById('carLength');

    const clothTableBody = document.querySelector('#clothTableFlatbar tbody');
    const btnAddCloth = document.getElementById('flatbarAddCloth');

    const CLOTH_PRESETS = {
      '4x3': 2400,
      '4x3.5': 2800,
      '6x3.5': 4200,
      '6x4': 4800,
      '7x3.5': 4900,
      '7x4': 5600,
      '8x4': 6500,
      '8x5': 8500
    };
    const PRESET_SIZES = {
      '4x3': {w:4, l:3},
      '4x3.5': {w:4, l:3.5},
      '6x3.5': {w:6, l:3.5},
      '6x4': {w:6, l:4},
      '7x3.5': {w:7, l:3.5},
      '7x4': {w:7, l:4},
      '8x4': {w:8, l:4},
      '8x5': {w:8, l:5}
    };

    function makeClothRow(defaultType='custom'){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <select class="ptype">
            <option value="custom" selected>ระบุเอง</option>
            <option value="4x3">4 ม. × 3 ม. — 2,400</option>
            <option value="4x3.5">4 ม. × 3.5 ม. — 2,800</option>
            <option value="6x3.5">6 ม. × 3.5 ม. — 4,200</option>
            <option value="6x4">6 ม. × 4 ม. — 4,800</option>
            <option value="7x3.5">7 ม. × 3.5 ม. — 4,900</option>
            <option value="7x4">7 ม. × 4 ม. — 5,600</option>
            <option value="8x4">8 ม. × 4 ม. — 6,500</option>
            <option value="8x5">8 ม. × 5 ม. — 8,500</option>
          </select>
        </td>
        <td><input type="number" class="cw" step="0.1" min="0.1" placeholder="กว้าง (ม.)"></td>
        <td><input type="number" class="cl" step="0.1" min="0.1" placeholder="ยาว (ม.)"></td>
        <td><input type="number" class="cq" value="1" min="1"></td>
        <td><button type="button" class="btn-danger del">ลบ</button></td>`;

      const sel = tr.querySelector('.ptype');
      const cw = tr.querySelector('.cw');
      const cl = tr.querySelector('.cl');
      const delBtn = tr.querySelector('.del');

      function applyType(){
        const val = sel.value;
        if(val!== 'custom'){
          const s = PRESET_SIZES[val];
          cw.value = s.w; cl.value = s.l;
          cw.disabled = true; cl.disabled = true;
        }else{
          cw.disabled = false; cl.disabled = false;
        }
      }

      sel.addEventListener('change', applyType);
      delBtn.addEventListener('click', ()=> tr.remove());

      // set default selection
      sel.value = defaultType;
      applyType();

      clothTableBody.appendChild(tr);
    }

    btnAddCloth.addEventListener('click', ()=> makeClothRow('custom'));
    // initial one row, default = custom
    makeClothRow('custom');

    function collectCloth(){
      const rows = [...clothTableBody.querySelectorAll('tr')];
      let has=false, price=0; let lines=[]; let simple=[];
      for(const tr of rows){
        const type = tr.querySelector('.ptype').value;
        const cw = parseFloat(tr.querySelector('.cw').value||0);
        const cl = parseFloat(tr.querySelector('.cl').value||0);
        const qty = Math.max(1, parseInt(tr.querySelector('.cq').value||1,10));

        if(type!== 'custom'){
          const u = CLOTH_PRESETS[type]||0;
          const s = PRESET_SIZES[type];
          const sum = u * qty;
          price += sum; has = has || sum>0;
          lines.push(`ผ้าขนาด ${s.w} ม. × ${s.l} ม. × ${qty} ผืน = ${sum.toLocaleString()} บาท`);
          simple.push({w:s.w, l:s.l, qty, sum});
        }else{
          if(!(cw>0 && cl>0)) continue; // skip invalid custom row
          const area = cw*cl; const unit = Math.floor(area*250); const sum = unit*qty;
          price += sum; has = has || sum>0;
          lines.push(`ผ้าขนาด ${cw} ม. × ${cl} ม. = ${area.toFixed(2)} ตร.ม. × ${qty} ผืน @250 บาท/ตร.ม. = ${sum.toLocaleString()} บาท`);
          simple.push({w:cw, l:cl, qty, sum});
        }
      }
      return {has, text: lines.join('\n'), price, simple};
    }

    function pickBars(len){
      let L = parseInt(len,10);
      if(isNaN(L) || L<2) return null;
      if(L===4) return {two:2, three:0};
      if(L===5) return {two:1, three:1};
      if(L===6) return {two:0, three:2};
      if(L===7) return {two:2, three:1};
      let three = Math.floor(L/3);
      while(three>=0){
        const remain = L - three*3;
        if(remain%2===0){
          const two = remain/2; return {two, three};
        }
        three--;
      }
      return null;
    }

    function calcFlatbarText(L, hasFrontCloth=false){
      const set = pickBars(L);
      if(!set) return { text: '', two:0, three:0, totalTwo:0, totalThree:0, totalLen:0, totalPrice:0 };

      const len = parseInt(L,10);
      const points = 4;
      const totalTwo = set.two * points;
      const totalThree = set.three * points;
      const totalLen = points * len;
      const basePrice = 300 + (totalLen * 50);
      const totalPrice = hasFrontCloth ? basePrice + 150 : basePrice;

      const items = [];
      if(totalTwo > 0) items.push(`เหล็กแบน 2 ม. × ${totalTwo} เส้น`);
      if(totalThree > 0) items.push(`เหล็กแบน 3 ม. × ${totalThree} เส้น`);
      const itemsLine = items.length ? items.join(', ') : '—';
      const remarkLines = hasFrontCloth ? 3 : 2;

      let t = '';
      t += `📦 ชุดเหล็กแบนสำหรับติดตั้ง MP Flow 2.0 \n`;
      t += `ความยาวรถ ${len} เมตร\n`;
      t += `ยอดสรุปรวม (เหล็กแบน) ${totalPrice} บาท\n\n`;
      t += `สิ่งที่จะได้รับ : ${itemsLine} \n\n`;
      t += `หมายเหตุ: รวมเหล็กสำหรับติดตั้งหัวท้าย 2.5 ม. × ${remarkLines} เส้น และฟรีสกรูสำหรับติดตั้งแล้ว`;

      return { text:t, two:set.two, three:set.three, totalTwo, totalThree, totalLen, totalPrice };
    }

    flatbarForm.onsubmit = function(e){
      e.preventDefault();
      const cloth = collectCloth();
      if(!cloth.has){ alert('กรุณาเพิ่มรายการผ้าอย่างน้อย 1 รายการ และกรอกให้ครบถ้วน'); return; }

      const cust = (document.getElementById('flatbarCustInfo').value||'').trim();
      const clothHeader = 'MP Flow 2.0 HDPE หนา 2 มิล';
      const fbName = (document.getElementById('flatbarFacebook').value||'').trim();
      const page = document.getElementById('flatbarPageSelect').value;
      const admin = document.getElementById('flatbarAdminSelect').value;
      const dateText = (document.getElementById('flatbarDate').value||'').trim();

      // เหล็กแบน (ไม่บังคับ)
      const L = parseInt(carLengthInput.value,10);
      const hasFront = document.getElementById('hasFrontCloth').checked;
      let kit=null;
      if(!isNaN(L) && L>=2){ kit = calcFlatbarText(L, hasFront); }

      // เริ่มประกอบข้อความรูปแบบใหม่
      let out = 'ส่ง';
      if(cust) out += `
${cust}`;
      out += `

${clothHeader}`;
      // ต่อบรรทัดขนาดและราคา
      for(const it of cloth.simple){
        const unit = `${it.w}x${it.l}`;
        const qtyPart = it.qty>1 ? ` × ${it.qty}` : '';
        out += `
ขนาด ${unit}${qtyPart} ราคา ${it.sum.toLocaleString()} บาท`;
      }

      // รวมยอดสำหรับการชำระเงิน
      const clothSum = cloth.price;
      const steelSum = (kit && kit.totalPrice) ? kit.totalPrice : 0;
      const grand = clothSum + steelSum;
      let dep = 0; if(grand>5000){ dep = Math.floor(grand*0.1); }
      const cod = grand - dep;

      out += `

ชำระปลายทางหลังได้รับสินค้า`;
      if(dep>0) out += `
มัดจำ 10% (${dep.toLocaleString()} บาท)`;
      out += `
COD ${cod.toLocaleString()}`;

      // ถ้ามีเหล็กแบน ให้ต่อบล็อกรายละเอียดไว้ท้าย ๆ (ไม่บังคับ)
      if(kit && kit.text){ out += `

${kit.text}`; }

      if(fbName) out += `

Facebook ${fbName}`;
      if(page) out += `
เพจ${page}`;
      if(admin) out += `
แอดมิน ${admin}`;
      if(dateText) out += `
${dateText}`;

      flatbarResult.value = out.trim();
      flatbarCopy.classList.remove('hidden');
      flatbarReset.classList.remove('hidden');
    };
    flatbarCopy.onclick = ()=>{ flatbarResult.select(); document.execCommand('copy'); alert('คัดลอกข้อความแล้ว'); };
    flatbarReset.onclick = ()=>{ flatbarForm.reset(); clothTableBody.innerHTML=''; makeClothRow('custom'); flatbarResult.value=''; flatbarCopy.classList.add('hidden'); flatbarReset.classList.add('hidden'); };

    // ---------- SUMMARY LOGIC (ไม่มีเหล็กแบน) ----------
    const tbody = document.querySelector('#itemsTable tbody');

    const addRow = () => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><select class="t">
          <option value="0.3L">LDPE 0.3</option>
          <option value="0.5L">LDPE 0.5</option>
          <option value="0.5H">HDPE 0.5</option>
          <option value="0.75H">HDPE 0.75</option>
        </select></td>
        <td><input class="w" type="number" step="0.01"></td>
        <td><input class="l" type="number" step="0.01"></td>
        <td><input class="d" type="number" step="0.01"></td>
        <td><input type="checkbox" class="canal"></td>
        <td><input class="q" type="number" value="1" min="1"></td>
        <td><button type="button" class="btn-danger del">ลบ</button></td>`;
      tr.querySelector('.del').onclick = () => tr.remove();
      tbody.appendChild(tr);
    };
    addRow();
    document.getElementById('addItem').onclick = addRow;

    document.getElementById('summaryForm').onsubmit = (e)=>{
      e.preventDefault();
      const cust = document.getElementById('custInfo').value.trim();
      const useFactory = document.getElementById('summaryFactoryBlue').checked; // เพจน้ำเงินราคาโรงงาน
      const useDiscount = document.getElementById('summaryDiscount5').checked;

      const PRICE = useFactory
        ? { '0.3L':40, '0.5L':50, '0.5H':60, '0.75H':80 }
        : { '0.3L':40, '0.5L':60, '0.5H':65, '0.75H':85 };

      const MAT = c => c.endsWith('L')?'LDPE':'HDPE';
      const THK = c => c.replace(/[LH]$/, '');
      const fmt = n => Math.floor(n).toLocaleString();

      let total=0, areaSum=0, list='', idx=1;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const code = tr.querySelector('.t').value;
        const w = parseFloat(tr.querySelector('.w').value||0);
        const l = parseFloat(tr.querySelector('.l').value||0);
        const d = parseFloat(tr.querySelector('.d').value||0);
        const q = parseInt(tr.querySelector('.q').value||1);
        const isCanal = tr.querySelector('.canal').checked;
        if(w<=0 || l<=0 || q<=0) return;
        let aw=w, al=l; if(d>0){ const pad=isCanal?1:2; aw=w+d*2+pad; al=l+d*2+pad; }
        let pricePer = PRICE[code];
        if(isCanal) pricePer = Math.floor(pricePer * 1.05);
        const area = aw*al; const cost = Math.floor(area * pricePer * q);
        total += cost; areaSum += area*q;
        list += `📍 รายการ ${idx}:\nผ้าพลาสติก ${MAT(code)} หนา ${THK(code)} มม. (${pricePer} บาท/ตร.ม.)\nผ้าขนาด ${aw} × ${al} ม. = ${fmt(area)} ตร.ม.\nราคาผ้า ${fmt(cost)} บาท\n`;
        if(q>1) list += `จำนวน ${q} ผืน\n`;
        idx++;
      });

      if(total===0){ return alert('กรุณากรอกอย่างน้อย 1 รายการ'); }

      let discountAmount=0; if(useDiscount){ discountAmount=Math.floor(total*0.05); total-=discountAmount; }
      let ship = total<5000?300:0; if(document.getElementById('summarySpecial').checked){ const ex=Math.floor(areaSum*5); ship += ex>2000?2000:ex; }
      const grand = Math.floor(total+ship); const dep = grand>=5000?Math.floor(grand*0.1):0; const bal = grand-dep;

      let out = cust?`ส่ง\n${cust}\n\n${list}`:list;
      out += `📌 สรุปยอดสั่งซื้อทั้งหมด\nยอดรวม ${fmt(grand)} บาท\n`;
      if(useFactory) out += `(ราคาโรงงาน เพจน้ำเงิน)\n`;
      if(useDiscount) out += `(ส่วนลดพิเศษ 5% = ${fmt(discountAmount)} บาท)\n`;
      out += ship?`ค่าจัดส่ง ${fmt(ship)} บาท\n`:'ส่งฟรี ชำระเงินเมื่อได้รับของค่ะ\n\n';
      if(dep) out += `✅ ชำระมัดจำ 10% (${fmt(dep)} บาท)`;
      out += `\n COD ${fmt(bal)} บาท\n\n`;
      out += `🚚 สินค้าจะจัดส่งถึงลูกค้าภายใน 4-6 วัน`;

      const page = document.getElementById('pageSelect').value; const admin = document.getElementById('adminSelect').value;
      if(page) out += `\n\nเพจ: ${page}`; if(admin) out += `\nแอดมิน: ${admin}`;
      document.getElementById('summaryResult').value = out.trim();
      document.getElementById('summaryCopy').classList.remove('hidden');
    };
    document.getElementById('summaryCopy').onclick = ()=>{ const t=document.getElementById('summaryResult'); t.select(); document.execCommand('copy'); alert('คัดลอกแล้ว'); };

    // --- quick smoke tests ---
    (function runTests(){
      console.log('[TEST] pondWidth exist =>', !!document.getElementById('pondWidth'));
      console.log('[TEST] canal Blue=50 OK =>', (document.getElementById('canalFactoryBlue')?true:false));
      console.log('[TEST] summary Blue map =>', (document.getElementById('summaryFactoryBlue')?true:false));
      console.log('[TEST] flatbar tab exist =>', !!document.getElementById('flatbarContainer'));
      console.log('[TEST] carLength input exist =>', !!document.getElementById('carLength'));
      console.log('[TEST] cloth table exist =>', !!document.getElementById('clothTableFlatbar'));

      // Functional sanity checks for flatbar
      const t5 = (function(){ const k = (function(L){ const r = (function pickBars(len){ let x=parseInt(len,10); if(isNaN(x)||x<2) return null; if(x===4) return {two:2,three:0}; if(x===5) return {two:1,three:1}; if(x===6) return {two:0,three:2}; if(x===7) return {two:2,three:1}; let three=Math.floor(x/3); while(three>=0){ const rem=x-three*3; if(rem%2===0) return {two:rem/2, three}; three--; } return null; })(L); if(!r) return 0; const base=300+(4*L*50); return base; })(5); return k; })();
      console.log('[TEST] calc flatbar base for 5m (no front cloth) =>', t5); // expect 1300
    })();
  </script>
</body>
</html>

